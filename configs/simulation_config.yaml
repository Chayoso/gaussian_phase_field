# ============================================================================
# MPM + Gaussian Splatting Crack Simulation Configuration
# ============================================================================

# Simulation metadata
simulation:
  name: "crack_simulation"
  description: "MPM-based crack propagation with Gaussian Splatting visualization"
  mode: "deformation"                    # "crack_only" (Fisher-KPP) | "deformation" (MPM + phase field)
  output_dir: "output"
  save_frames: true
  save_checkpoint: true
  checkpoint_interval: 100  # Save every N frames

# Input mesh configuration
mesh:
  path: "assets/meshes/bunny.obj"  # Mesh file path (OBJ/PLY)
  auto_generate_if_missing: true    # Generate test sphere if mesh not found
  test_mesh_type: "sphere"          # Options: "sphere", "cube", "torus"
  test_mesh_radius: 0.4

# Particle sampling configuration
particles:
  target_count: 50000               # Total particles (reduced for physics speed)
  surface_ratio: 0.4                # Surface particle ratio (0.0-1.0)
  use_poisson_sampling: false       # Use Poisson reconstruction (experimental)
  poisson_depth: 8                  # Octree depth for Poisson
  normalize_to_unit_cube: true      # Normalize mesh to [0, 1]³

# MPM simulation parameters
mpm:
  num_grids: 64                     # Grid resolution (64³ cells)
  dt: 5.0e-5                        # Time step (reduced for slower, more stable simulation)
  gravity: [0.0, 0.0, 0.0]          # No gravity (object fixed in place)
  clip_bound: 0.05                  # Boundary distance (fraction of domain)
  damping: 0.98                     # Velocity damping (absorbing boundary handles wave reflection)
  particle_chunk: 8192              # Chunk size for memory efficiency

# Material properties
material:
  constitutive_model: "corotated_phase_field"  # "phase_field" (SVK) | "corotated_phase_field"
  center: [0.5, 0.5, 0.5]          # Material center (MPM space)
  size: [0.8, 0.8, 0.8]            # Material extent
  density: 1000.0                   # Material density (kg/m³)

  # Elasticity parameters
  youngs_modulus: 1.0e6            # Young's modulus (Pa)
  poissons_ratio: 0.35             # Poisson's ratio (0.0-0.5)

  # Phase field fracture parameters (AT2 model)
  Gc: 30.0                         # Fracture toughness — background psi<threshold, crack tip psi>threshold
  l0: 0.025                        # Regularization length (~1.5x dx = sharp crack band)
  degradation_exponent: 3.0        # Degradation function exponent

# Phase field evolution parameters
phase_field:
  warmup_frames: 5                  # Substeps before crack growth (stabilize H first)
  dC_max: 0.05                     # Maximum damage increment per step (rate limiter)

  # Crack-tip tracking parameters
  crack_tip_speed: 1.5              # Tip advance speed (cells per frame, slower propagation)
  crack_width: 0.015                # Width of damage band (narrow = thin crack lines)
  max_total_cracks: 12              # Allow branching + multiple notch paths

  # Anisotropic diffusion (for stress eigenvector computation)
  crack_aniso_ratio: 200.0          # Used for _compute_aniso_diffusion → n1_grid

  # Branching parameters
  branch_angle: 35.0                # Branch fork angle (degrees from parent direction)
  branch_min_length: 6              # Minimum segments before a path can branch
  branch_probability: 0.3           # Probability of branching per eligible tip per frame
  max_branches_per_path: 1          # Max times a single path can branch

  # Nucleation parameters
  nucleation_fraction: 0.6          # Allow some natural nucleation in high-stress zones
  max_nucleation_per_frame: 1       # One new crack per frame max (interior only)
  nucleation_min_spacing: 10        # Min grid cells between crack paths

# Seismic loading (earthquake ground motion)
seismic:
  enabled: true                     # Enable oscillating ground acceleration
  amplitude: 500.0                  # Peak ground acceleration — moderate (only crack tip exceeds Gc)
  frequency: 80.0                   # Oscillation frequency (Hz) — ~4 cycles in 0.05s sim time
  direction: [1.0, 0.0, 0.0]       # Shaking direction (horizontal x-axis)
  ramp_time: 0.005                  # Ramp-up time (seconds) to avoid initial shock

# Pre-notch configuration (initial crack seeds — multiple directions)
pre_notch:
  enabled: true                     # Enable pre-notch (deterministic crack locations)
  notches:
    - start: [0.30, 0.45, 0.50]    # Horizontal cut across torso (x-axis)
      end: [0.70, 0.45, 0.50]
      damage: 0.9
    - start: [0.40, 0.55, 0.42]    # Diagonal cut (angled across body)
      end: [0.60, 0.35, 0.58]
      damage: 0.85
    - start: [0.48, 0.30, 0.46]    # Near-vertical cut (up through body)
      end: [0.52, 0.65, 0.54]
      damage: 0.85

# External force configuration (initial impact / crack seed)
external_force:
  enabled: false                    # Disabled: seismic loading handles crack initiation via nucleation
  application_time: 0.0             # Time to apply force (seconds)
  center: [0.5, 0.8, 0.5]          # Force center (MPM space)
  magnitude: 5.0                    # Impact energy (normalized)
  radius: 0.03                      # Impact radius (small point, ~2 grid cells)
  direction: null                   # Force direction (null = radial)

# Coordinate mapping (MPM ↔ World space)
coordinate_mapping:
  world_center: [0.5, 0.5, 0.5]    # World space origin (mesh center)
  world_scale: 1.0                  # World space extent (1:1 with MPM)

# Damage projection (Volume → Surface)
damage_projection:
  method: "knn_weighted"            # Options: "knn_weighted", "direct", "ray_casting"
  k_neighbors: 8                    # Number of nearest neighbors
  influence_radius: 0.05            # Gaussian kernel width (MPM space)
  damage_threshold: 0.01            # Minimum damage to visualize
  use_faiss: true                   # Use FAISS GPU acceleration

# Gaussian Splatting visualization
gaussian_splatting:
  sh_degree: 3                      # Spherical harmonics degree (0-3, use 3 for depth version)

  # Crack visualization (sharp mode)
  crack_color: [0.8, 0.1, 0.1]     # RGB crack color (red)
  opacity_mode: "smooth"            # Options: "degradation", "binary", "smooth"
  color_mode: "overlay"             # Options: "overlay", "replace", "darken"
  scale_mode: null                  # Options: null, "widen", "shrink"
  damage_threshold: 0.2             # Crack threshold (lower = earlier visibility)
  sharp_k: 30.0                    # Sigmoid steepness for crack edge (higher = sharper)
  edge_width: 0.12                 # Width of the red edge zone around threshold
  crack_opacity_reduction: 0.85    # Opacity reduction for crack interior (0.85 = 85%)

  # Crack opening (physical displacement)
  crack_max_opening: 0.003         # Minimal edge displacement (thin cracks)
  crack_gap_fraction: 0.1         # Narrow center opacity dip
  crack_edge_darken: 0.6          # Edge darkening factor (darker lines)
  crack_red_accent: 0.08          # Very thin red accent at boundary

# Rendering configuration
rendering:
  image_width: 800
  image_height: 800
  background_color: [1.0, 1.0, 1.0]  # RGB background (white)

  # Camera settings
  camera:
    distance: 2.0                    # Distance from origin (safe distance outside mesh)
    elevation: 25.0                  # Elevation angle (degrees)
    azimuth: 45.0                    # Azimuth angle (degrees)
    fov: 50.0                        # Field of view (degrees)

  # Animation settings
  total_frames: 150                  # Total frames to simulate (more time for crack development)
  fps: 30                            # Output video framerate
  physics_substeps: 10               # MPM steps per render frame (doubled for halved dt)

# Output configuration
output:
  video_path: "output/crack_simulation.mp4"
  frame_dir: "output/frames"
  statistics_log: "output/statistics.csv"
  checkpoint_dir: "output/checkpoints"

  # Logging
  log_interval: 50                   # Print statistics every N frames
  verbose: true

# Device configuration
device:
  type: "cuda"                       # Options: "cuda", "cpu"
  gpu_id: 0                          # GPU device ID (if multiple GPUs)
